<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <div th:insert="~{/general/head.html}"></div>

    <!-- Editable CSS -->
    <!-- Custom CSS -->
    <link th:href="@{/css/bootstrap-wysihtml5.css}" rel="stylesheet">
    <link th:href="@{/css/style.min.css}" rel="stylesheet">
    <!-- page css -->
    <link th:href="@{/css/pages/inbox.css}" rel="stylesheet">

    <!-- SweetAlert2 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body class="skin-blue fixed-layout">
    <!-- Preloader -->
    <div class="preloader">
        <div class="loader">
            <div class="loader__figure"></div>
            <p class="loader__label">CRM</p>
        </div>
    </div>

    <!-- Main Wrapper -->
    <div id="main-wrapper">
        <!-- Header -->
        <div th:insert="~{/general/header.html}"></div>

        <!-- Left Sidebar -->
        <div th:insert="~{/general/left-sidebar.html}"></div>

        <!-- Page Wrapper -->
        <div class="page-wrapper">
            <!-- Container Fluid -->
            <div class="container-fluid">
                <!-- Bread crumb and right sidebar toggle -->
                <div th:insert="~{/general/page-titles.html}"></div>

                <!-- Start Page Content -->
                <div class="row">
                    <div class="col-lg-12">
                        <div class="card">
                            <div class="card-body">
                                <h4 class="card-title">Create New Ticket</h4>
                                <form th:object="${ticket}" th:action="@{/employee/ticket/create-ticket}" method="post" id="ticketForm">

                                    <!-- Subject -->
                                    <label class="m-t-20" for="subject">Subject:</label>
                                    <div class="input-group">
                                        <input type="text" id="subject" th:field="*{subject}" class="form-control">
                                    </div>
                                    <div class="input-group">
                                        <span class="text-danger font-weight-bold" th:if="${#fields.hasErrors('subject')}" th:errors="*{subject}"></span>
                                    </div>

                                    <!-- Description -->
                                    <label class="m-t-20" for="description">Description:</label>
                                    <div class="input-group">
                                        <textarea class="textarea_editor form-control" id="description" rows="15" placeholder="Enter text ..." th:field="*{description}"></textarea>
                                    </div>
                                    <div class="input-group">
                                        <span class="text-danger font-weight-bold" th:if="${#fields.hasErrors('description')}" th:errors="*{description}" autocomplete="off"></span>
                                    </div>

                                    <!-- Status -->
                                    <label class="m-t-20" for="status">Status:</label>
                                    <div class="input-group">
                                        <select id="status" th:field="*{status}" class="form-control">
                                            <option value="open">Open</option>
                                            <option value="assigned">Assigned</option>
                                            <option value="on-hold">On Hold</option>
                                            <option value="in-progress">In Progress</option>
                                            <option value="resolved">Resolved</option>
                                            <option value="closed">Closed</option>
                                            <option value="reopened">Reopened</option>
                                            <option value="pending-customer-response">Pending Customer Response</option>
                                            <option value="escalated">Escalated</option>
                                            <option value="archived">Archived</option>
                                        </select>
                                    </div>
                                    <div class="input-group">
                                        <span class="text-danger font-weight-bold" th:if="${#fields.hasErrors('status')}" th:errors="*{status}"></span>
                                    </div>

                                    <!-- Priority -->
                                    <label class="m-t-20" for="priority">Priority:</label>
                                    <div class="input-group">
                                        <select id="priority" th:field="*{priority}" class="form-control">
                                            <option value="low">Low</option>
                                            <option value="medium">Medium</option>
                                            <option value="high">High</option>
                                            <option value="closed">Closed</option>
                                            <option value="urgent">Urgent</option>
                                            <option value="critical">Critical</option>
                                        </select>
                                    </div>
                                    <div class="input-group">
                                        <span class="text-danger font-weight-bold" th:if="${#fields.hasErrors('priority')}" th:errors="*{priority}"></span>
                                    </div>

                                    <!-- Assign Employee -->
                                    <label class="m-t-20" for="employeeId">Assign Employee:</label>
                                    <div class="input-group">
                                        <select name="employeeId" id="employeeId" class="form-control">
                                            <option th:each="employee : ${employees}" th:text="${employee.username}" th:value="${employee.id}"></option>
                                        </select>
                                    </div>

                                    <!-- Customer -->
                                    <label class="m-t-20" for="customerId">Customer:</label>
                                    <div class="input-group">
                                        <select name="customerId" id="customerId" class="form-control">
                                            <option th:each="customer : ${customers}" th:text="${customer.name}" th:value="${customer.customerId}"></option>
                                        </select>
                                    </div>

                                    <!-- Expenses Section -->
                                    <h4 class="card-title m-t-40">Expenses</h4>
                                    <div id="expenses-container">
                                        <div class="expense-entry">
                                            <label class="m-t-20" for="expenseAmount">Amount:</label>
                                            <div class="input-group">
                                                <input type="number" step="0.01" name="expenses[0].amount" class="form-control" placeholder="Enter amount">
                                            </div>

                                            <label class="m-t-20" for="expenseDescription">Description:</label>
                                            <div class="input-group">
                                                <textarea name="expenses[0].description" class="form-control" placeholder="Enter description"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" id="add-expense" class="btn btn-secondary m-t-20">Add Expense</button>
                                    <br>

                                    <!-- Champ caché pour stocker la décision de l'utilisateur -->
                                    <input type="hidden" id="userConfirmation" name="userConfirmation" value="false">

                                    <div th:if="${errorMessage}" class="alert alert-danger" role="alert">
                                        <span th:text="${errorMessage}"></span>
                                    </div>

                                    <!-- Submit Button -->
                                    <button type="submit" class="btn btn-primary m-t-20">Create Ticket</button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- End Page Content -->
            </div>
            <!-- End Container Fluid -->
        </div>
        <!-- End Page Wrapper -->

        <!-- Right Sidebar -->
        <div th:insert="~{/general/right-sidebar.html}"></div>

        <!-- Footer -->
        <div th:insert="~{/general/footer.html}"></div>
    </div>
    <!-- End Wrapper -->

    <!-- All Jquery -->
    <script th:inline="javascript">
        var home = /*[[${home}]]*/ null;
    </script>
    <script th:src="@{/js/library/jquery-3.2.1.min.js}" type="text/javascript"></script>
    <script th:src="@{/js/library/popper.min.js}" type="text/javascript"></script>
    <script th:src="@{/js/library/bootstrap.min.js}" type="text/javascript"></script>
    <script th:src="@{/js/library/perfect-scrollbar.jquery.min.js}" type="text/javascript"></script>
    <script th:src="@{/js/library/waves.js}" type="text/javascript"></script>
    <script th:src="@{/js/library/sidebarmenu.js}" type="text/javascript"></script>
    <script th:src="@{/js/library/sticky-kit.min.js}"></script>
    <script th:src="@{/js/library/jquery.sparkline.min.js}" type="text/javascript"></script>
    <script th:src="@{/js/library/custom.min.js}" type="text/javascript"></script>
    <script th:src="@{/js/library/wysihtml5-0.3.0.js}"></script>
    <script th:src="@{/js/library/bootstrap-wysihtml5.js}"></script>

    <!-- SweetAlert2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>
        $(document).ready(function() {
            $('.textarea_editor').wysihtml5();

            // Add new expense fields dynamically
            let expenseIndex = 1;
            $('#add-expense').click(function() {
                const newExpenseEntry = `
                    <div class="expense-entry m-t-20">
                        <label class="m-t-20" for="expenseAmount">Amount:</label>
                        <div class="input-group">
                            <input type="number" step="0.01" name="expenses[${expenseIndex}].amount" class="form-control" placeholder="Enter amount">
                        </div>

                        <label class="m-t-20" for="expenseDescription">Description:</label>
                        <div class="input-group">
                            <textarea name="expenses[${expenseIndex}].description" class="form-control" placeholder="Enter description"></textarea>
                        </div>
                    </div>
                `;
                $('#expenses-container').append(newExpenseEntry);
                expenseIndex++;
            });
        });

        // Intercept form submission
        document.getElementById('ticketForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const formData = new FormData(this);

            fetch('/employee/ticket/check-budget', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.exceedsBudget) {
                    // Use SweetAlert2 for confirmation
                    Swal.fire({
                        title: 'Attention !',
                        text: "Le montant des dépenses dépasse le budget du client. Voulez-vous vraiment continuer ?",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Oui, continuer',
                        cancelButtonText: 'Annuler'
                    }).then((result) => {
                        if (result.isConfirmed) {
                            document.getElementById('ticketForm').submit();
                        }
                    });
                } else {
                    document.getElementById('ticketForm').submit();
                }
            })
            .catch(error => {
                console.error('Erreur lors de la vérification du budget:', error);
            });
        });
    </script>
</body>
</html>
